<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>TEST_TITLE</title>
    <link rel="stylesheet" href="style.css">
    <script src="xplugin_embind.js"></script>
  </head>

  <!-- inplace javascript -->
    <script type="text/javascript">
    



        function createDynlibFS(
            lib,
            searchDirs,
            readFileFunc,
            Module
        ) {
            const dirname = lib.substring(0, lib.lastIndexOf("/"));

            let _searchDirs = searchDirs || [];



            const resolvePath = (path) => {
                //console.log("resolvePath", path);
                
                if (Module.PATH.basename(path) !== Module.PATH.basename(lib)) {
                    //console.debug(`Searching a library from ${path}, required by ${lib}`);
                }

                for (const dir of _searchDirs) {
                    const fullPath = Module.PATH.join2(dir, path);
                    //console.log("SERARCHING", fullPath);
                    if (Module.FS.findObject(fullPath) !== null) {
                        //console.log("FOUND", fullPath);   
                        return fullPath;
                    }
                }
                return path;
            };

            let readFile = (path) =>
                Module.FS.readFile(resolvePath(path));

            if (readFileFunc !== undefined) {
                readFile = (path) => readFileFunc(resolvePath(path));
            }

            const fs = {
                findObject: (path, dontResolveLastLink) => {
                    let obj = Module.FS.findObject(resolvePath(path), dontResolveLastLink);

                    if (obj === null) {
                        console.debug(`Failed to find a library: ${resolvePath(path)}`);
                    }

                    return obj;
                },
                readFile: readFile,
            };

            return fs;
        }







        async function fu(){
            // main function
            console.log("driver() called", this);
            let Module = await createModule();
            
            console.log("Module", Module);

            let plugin_names = [
                "plugin_01",
                "plugin_02",
                "plugin_03",
            ]

            // make dir
            Module.FS.mkdir("/plugins");

            



            // fetch all plugins
            for (let i = 0; i < plugin_names.length; i++) {
                let plugin_name = plugin_names[i];
                let response = await fetch(`./lib${plugin_name}.so`);
                // console.log("response", response);
                let buffer = await response.arrayBuffer();
                console.log("buffer", buffer);

                // write to emscripten fs
                let filename = `/plugins/lib${plugin_name}.so`;
                let data = new Uint8Array(buffer);

                console.log("filename", filename);
                Module.FS.writeFile(filename, data);

                // instantiate all SO files
                const fs = createDynlibFS(filename, ["/plugins/"], Module.FS.readFile, Module);
                const libName = Module.PATH.basename(filename);

                await Module.loadDynamicLibrary(libName, {
                    loadAsync: true,
                    nodelete: true,
                    allowUndefined: true,
                    global: true,
                    fs: fs
                 })

                 
            }
            Module.run_tests();
                
        };
        fu();

    </script>

  <body>
    <!-- page content -->
  </body>


</html>